name: Sample CI
on: [push, pull_request]

jobs:
  test-functions:
    strategy:
      matrix:
        function:
          - functions/csv-import
          - functions/log-event
          - functions/process-events
    name: Test Function - ${{ matrix.function }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      - name: Install Python dependencies
        run: pip install -r requirements.txt
        working-directory: ${{ matrix.function }}
      - name: Install HTTPie and additional dependencies for API testing
        run: |
          pip install httpie
          pip install pandas requests
        if: matrix.function == 'functions/csv-import'
      - name: Run tests if test_main.py exists
        run: |
          if [ -f "test_main.py" ]; then
            echo "Running tests with test_main.py"
            pytest
          else
            echo "No test_main.py found, skipping tests"
          fi
        working-directory: ${{ matrix.function }}
      - name: Run Python function and verify output
        run: |
          python main.py > output.log 2>&1 &
          PID=$!
          timeout=30
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if grep -q "running at port 8081" output.log; then
              echo "✅ Application started successfully"
              break
            fi
            sleep 1
            elapsed=$((elapsed+1))
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "❌ Application failed to start within $timeout seconds"
            echo "=== Application startup log ==="
            cat output.log
            echo "=== End of startup log ==="
            kill $PID 2>/dev/null || true
            exit 1
          fi
          
          # Run additional requests for csv-import function
          if [[ "${{ matrix.function }}" == "functions/csv-import" ]]; then
            echo "Running additional requests for csv-import function..."
          
            # Debug: Show current directory and files
            echo "=== Debug: Current directory and files ==="
            pwd
            ls -la
            echo "=== End debug info ==="
          
            # Wait a moment for the service to be fully ready
            sleep 2
          
            # Create sample CSV file if it doesn't exist
            if [ ! -f "security_events.csv" ]; then
              echo "Creating sample security_events.csv file..."
              echo "timestamp,event_type,severity,description,source_ip,destination_ip,user" > security_events.csv
              echo "2025-07-11T14:14:08Z,login_failure,medium,Failed login from IP 192.168.1.100,192.168.1.100,192.168.1.1,test.user" >> security_events.csv
              echo "2025-07-11T14:15:22Z,malware_detected,high,Malware detected on workstation,192.168.1.101,192.168.1.1,admin.user" >> security_events.csv
              echo "Sample CSV created:"
              cat security_events.csv
            else
              echo "Using existing security_events.csv:"
              cat security_events.csv
            fi
          
            # Request 1 - Import CSV with file path (your original HTTPie command)
            echo "=== Making first request (import with file path) ==="
          
            echo "Executing: http POST :8081 method=POST url=/import-csv 'body[csv_file_path]=security_events.csv'"
            http POST :8081 method=POST url=/import-csv "body[csv_file_path]=security_events.csv" > request1_output.log 2>&1
            REQUEST1_EXIT_CODE=$?
          
            echo "Request 1 exit code: $REQUEST1_EXIT_CODE"
            echo "Request 1 full output:"
            cat request1_output.log
          
            if [ $REQUEST1_EXIT_CODE -eq 0 ]; then
              echo "✅ First HTTPie request executed successfully"
          
              # Verify response structure
              if grep -q '"success"' request1_output.log; then
                echo "✅ Found 'success' field in response"
                if grep -q '"success": true' request1_output.log; then
                  echo "✅ Success is true"
                else
                  echo "⚠️  Success is not true"
                fi
              else
                echo "⚠️  'success' field not found in response"
              fi
          
              if grep -q '"total_rows"' request1_output.log; then
                echo "✅ Found 'total_rows' field in response"
              else
                echo "⚠️  'total_rows' field not found in response"
              fi
            else
              echo "❌ First HTTPie request failed with exit code: $REQUEST1_EXIT_CODE"
              echo "=== Current application log (last 20 lines) ==="
              tail -20 output.log
              echo "=== End application log ==="
              # Fail the workflow if the first request fails
              kill $PID 2>/dev/null || true
              exit 1
            fi
          
            # Request 2 - Import CSV with inline data (your original HTTPie command)
            echo "=== Making second request (import with CSV data) ==="
          
            echo "Executing: http POST :8081 method=POST url=/import-csv 'body[csv_data]=\"\$(cat security_events.csv)\"'"
            http POST :8081 method=POST url=/import-csv 'body[csv_data]="$(cat security_events.csv)"' > request2_output.log 2>&1
            REQUEST2_EXIT_CODE=$?
          
            echo "Request 2 exit code: $REQUEST2_EXIT_CODE"
            echo "Request 2 full output:"
            cat request2_output.log
          
            if [ $REQUEST2_EXIT_CODE -eq 0 ]; then
              echo "✅ Second HTTPie request executed successfully"
          
              # Verify response structure
              if grep -q '"success": true' request2_output.log; then
                echo "✅ Success flag is true in second request response"
              else
                echo "⚠️  Success flag not true in second request response"
              fi
          
              if grep -q '"processed_rows"' request2_output.log; then
                echo "✅ Found 'processed_rows' field in response"
              else
                echo "⚠️  'processed_rows' field not found in response"
              fi
            else
              echo "❌ Second HTTPie request failed with exit code: $REQUEST2_EXIT_CODE"
              # Fail the workflow if the second request fails
              kill $PID 2>/dev/null || true
              exit 1
            fi
          
            # Request 3 - Execute import.py script (only if it exists)
            if [ -f "import.py" ]; then
              echo "=== Running third test (executing import.py script) ==="
              python import.py > import_output.log 2>&1
              IMPORT_EXIT_CODE=$?
          
              echo "Import script exit code: $IMPORT_EXIT_CODE"
              echo "Import script output:"
              cat import_output.log
          
              if [ $IMPORT_EXIT_CODE -eq 0 ]; then
                echo "✅ import.py executed successfully"
          
                # Check for expected response fields
                if grep -q '"success"' import_output.log; then
                  echo "✅ Found 'success' field in import.py output"
                else
                  echo "⚠️  'success' field not found in import.py output"
                fi
              else
                echo "❌ import.py failed with exit code: $IMPORT_EXIT_CODE"
                # Fail the workflow if import.py fails
                kill $PID 2>/dev/null || true
                exit 1
              fi
            else
              echo "⚠️  import.py not found in function directory, skipping script test"
            fi
          
            # Final application log check
            echo "=== Final application status ==="
            if ps -p $PID > /dev/null 2>&1; then
              echo "✅ Application process still running (PID: $PID)"
            else
              echo "⚠️  Application process no longer running"
            fi
          
            echo "=== Final application log (last 30 lines) ==="
            tail -30 output.log
            echo "=== End final log ==="
          fi
          
          # Clean up
          kill $PID 2>/dev/null || true
        working-directory: ${{ matrix.function }}

  test-ui:
    name: Build and Test UI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Install dependencies
        run: npm ci
        working-directory: ui/extensions/user-preferences
      - name: Build React app
        run: npm run build
        working-directory: ui/extensions/user-preferences
      - name: Test React app
        run: npm run test:ci
        working-directory: ui/extensions/user-preferences
